"use server";

import { createSupabaseServerReadClient } from "@/lib/supabase/server-read";


export async function getTodosAll(userId: number) {

	const supabase = await createSupabaseServerReadClient(); // ✔ MUST use await
	return await supabase.from("todo").select("*").eq("todo_user_id", userId).order("todo_id");

}

export async function deleteTodo(id: number) {
	const supabase = await createSupabaseServerReadClient(); // ✔
	return await supabase.from("todo").delete().eq("todo_id", id);
}

export async function upsertTodo(payload: {
	id: number;
	creation: Date;
	cloture: Date;
	titre: string;
	text: string;
	important: boolean;
	urgent: boolean;
	etatId: number;
	user: {
		id: string;
	};
}) {
	const supabase = await createSupabaseServerReadClient(); // ✔

	if (payload.id === 0) {
		return await supabase.from("todo").insert({
			todo_creation: payload.creation,
			todo_cloture: payload.cloture,
			todo_titre: payload.titre,
			todo_text: payload.text,
			todo_important: payload.important,
			todo_urgent: payload.urgent,
			todo_etat_id: payload.etatId,
			todo_user_id: payload.user.id,
		});
	}

	return await supabase
		.from("todo")
		.update({
			todo_creation: payload.creation,
			todo_cloture: payload.cloture,
			todo_titre: payload.titre,
			todo_text: payload.text,
			todo_important: payload.important,
			todo_urgent: payload.urgent,
			todo_etat_id: payload.etatId,
			todo_user_id: payload.user.id,
		})
		.eq("todo_id", payload.id);
}

export async function getTodoByUrgent(urgent: boolean) {
	const supabase = await createSupabaseServerReadClient();

	const { data, error } = await supabase
		.from("todo")
		.select("*")
		.eq("todo_urgent", urgent)
		.order("todo_titre", { ascending: true });

	if (error) {
		console.error("Erreur getTodoByUrgent:", error);
		return [];
	}

	return data;
}

export async function getTodoByImportant(important: boolean) {
	const supabase = await createSupabaseServerReadClient();

	const { data, error } = await supabase
		.from("todo")
		.select("*")
		.eq("todo_important", important)
		.order("todo_titre", { ascending: true });

	if (error) {
		console.error("Erreur getTodoByUrgent:", error);
		return [];
	}

	return data;
}

export async function getTodoByImportantAndUrgent(important: boolean, urgent: boolean) {
	const supabase = await createSupabaseServerReadClient();

	const { data, error } = await supabase
		.from("todo")
		.select("*")
		.eq("todo_important", important)
		.eq("todo_urgent", urgent)
		.order("todo_titre", { ascending: true });

	if (error) {
		console.error("Erreur getTodoByImportantAndUrgent:", error);
		return [];
	}

	return data;
}
